# @format

name: Build and Deploy

on:
    push:
        branches: [main]

jobs:
    build-and-deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Write .env file from secret
              run: echo "${{ secrets.ENV_CONTENT }}" > .env
              working-directory: ${{ github.workspace }}

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Build release binary
              run: cargo build --release --bin backend
              working-directory: ${{ github.workspace }}

            - name: Stop insigniames service
              run: sudo systemctl stop insigniames

            - name: Move new binary, .env, and static files to deployment directory
              working-directory: ${{ github.workspace }}
              run: |
                  mkdir -p /home/insigniames/target/release
                  cp target/release/backend /home/insigniames/target/release/insigniames
                  cp .env /home/insigniames/target/release/.env
                  cp -r static /home/insigniames/target/release/static
                  chmod +x /home/insigniames/target/release/insigniames
                  sudo setcap 'cap_net_bind_service=+ep' /home/insigniames/target/release/insigniames

            - name: Restart insigniames service
              run: |
                  sudo systemctl restart insigniames
                  echo "Deployment complete!"
