# @format

name: Build and Deploy

on:
    push:
        branches: [main]

jobs:
    build-and-deploy:
        runs-on: self-hosted
        env:
            CARGO_HOME: /home/mes/.cargo
            CARGO_TARGET_DIR: /home/insigniames/target
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  clean: false

            - name: Write .env file from secret
              run: |
                  mkdir -p /home/insigniames/target/release
                  echo "${{ secrets.ENV_CONTENT }}" > /home/insigniames/target/release/.env

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      /home/mes/.cargo/registry
                      /home/mes/.cargo/git
                      /home/insigniames/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Build release binary
              run: cargo build --release --bin backend
              working-directory: ${{ github.workspace }}

            - name: Stop insigniames service
              run: sudo systemctl stop insigniames

            - name: Move new binary, .env, and static files to deployment directory
              working-directory: ${{ github.workspace }}
              run: |
                  cp /home/insigniames/target/release/backend /home/insigniames/target/release/insigniames
                  cp -r static /home/insigniames/target/release/static
                  chmod +x /home/insigniames/target/release/insigniames
                  sudo setcap 'cap_net_bind_service=+ep' /home/insigniames/target/release/insigniames

            - name: Restart insigniames service
              run: |
                  sudo systemctl restart insigniames
                  echo "Deployment complete!"
